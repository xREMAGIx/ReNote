"use strict";(self.webpackChunkrenote=self.webpackChunkrenote||[]).push([[5414],{8546:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>g,frontMatter:()=>t,metadata:()=>c,toc:()=>o});var a=i(5893),s=i(1151);const t={sidebar_position:2},r="Image Manipulation",c={id:"docker/image-manipulation",title:"Image Manipulation",description:"The process of creating, managing, and customizing images used to run containers in Docker.",source:"@site/docs/docker/image-manipulation.md",sourceDirName:"docker",slug:"/docker/image-manipulation",permalink:"/renote/docs/docker/image-manipulation",draft:!1,unlisted:!1,editUrl:"https://github.com/xREMAGIx/renote/tree/main/docs/docker/image-manipulation.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Concepts",permalink:"/renote/docs/docker/concept"},next:{title:"Container Manipulation",permalink:"/renote/docs/docker/container-manipulation"}},l={},o=[{value:"Create a Image",id:"create-a-image",level:2},{value:"Create Dockerfile",id:"create-dockerfile",level:3},{value:"Build image",id:"build-image",level:3},{value:"Tag docker Image",id:"tag-docker-image",level:2},{value:"List and Remove Images",id:"list-and-remove-images",level:2},{value:"Layers of Docker Image",id:"layers-of-docker-image",level:2},{value:"Build NGINX from Source",id:"build-nginx-from-source",level:2},{value:"Optimize Docker Image",id:"optimize-docker-image",level:2},{value:"Embracing Alpine Linux",id:"embracing-alpine-linux",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"image-manipulation",children:"Image Manipulation"}),"\n",(0,a.jsx)(n.p,{children:"The process of creating, managing, and customizing images used to run containers in Docker."}),"\n",(0,a.jsx)(n.h2,{id:"create-a-image",children:"Create a Image"}),"\n",(0,a.jsx)(n.h3,{id:"create-dockerfile",children:"Create Dockerfile"}),"\n",(0,a.jsxs)(n.p,{children:["Create a new file named ",(0,a.jsx)(n.code,{children:"Dockerfile"})," inside that directory. A Dockerfile is a collection of instructions that, once processed by the daemon, results in an image"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="Dockerfile"',children:'FROM ubuntu:latest\n\nEXPOSE 80\n\nRUN apt-get update && \\\n    apt-get install nginx -y && \\\n    apt-get clean && rm -rf /var/lib/apt/lists/*\n\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"FROM"}),": instruction ",(0,a.jsx)(n.em,{children:"sets the base"})," image for your resultant image.\n-> By setting ",(0,a.jsx)(n.code,{children:"ubuntu:latest"})," as the base image here, you get all the goodness of Ubuntu already available in your custom image"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"EXPOSE"}),": instruction is used to ",(0,a.jsx)(n.em,{children:"indicate the port"})," that needs to be published.\n-> Here it works like a documentation for someone who's trying to run a container using your image."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"RUN"}),": instruction ",(0,a.jsx)(n.em,{children:"executes a command"})," inside the container shell. The ",(0,a.jsx)(n.code,{children:"RUN"})," instructions here are written in ",(0,a.jsx)(n.code,{children:"shell"})," form. These can also be written in ",(0,a.jsx)(n.code,{children:"exec"})," form\n-> Run those simple Ubuntu commands."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"CMD"}),": instruction ",(0,a.jsx)(n.em,{children:"sets the default command"})," for your image. This instruction is written in ",(0,a.jsx)(n.code,{children:"exec"})," form or in ",(0,a.jsx)(n.code,{children:"shell"})," form.\n-> Running NGINX as a single process inside containers."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"build-image",children:"Build image"}),"\n",(0,a.jsx)(n.p,{children:"To perform an image build, the daemon needs two very specific pieces of information."}),"\n",(0,a.jsxs)(n.p,{children:["These are the name of the ",(0,a.jsx)(n.code,{children:"Dockerfile"})," and the ",(0,a.jsx)(n.code,{children:"build"})," context."]}),"\n",(0,a.jsx)(n.p,{children:"The image related commands can be issued using the following syntax:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker image <command> <options>\n"})}),"\n",(0,a.jsxs)(n.p,{children:["To build an image using the ",(0,a.jsx)(n.code,{children:"Dockerfile"})," you just wrote, open up your terminal inside the current directory and execute the following command:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'docker image build .\n\n# Sending build context to Docker daemon  3.584kB\n# Step 1/4 : FROM ubuntu:latest\n#  ---\x3e d70eaf7277ea\n# Step 2/4 : EXPOSE 80\n#  ---\x3e Running in 9eae86582ec7\n# Removing intermediate container 9eae86582ec7\n#  ---\x3e 8235bd799a56\n# Step 3/4 : RUN apt-get update &&     apt-get install nginx -y &&     apt-get clean && rm -rf /var/lib/apt/lists/*\n#  ---\x3e Running in a44725cbb3fa\n### LONG INSTALLATION STUFF GOES HERE ###\n# Removing intermediate container a44725cbb3fa\n#  ---\x3e 3066bd20292d\n# Step 4/4 : CMD ["nginx", "-g", "daemon off;"]\n#  ---\x3e Running in 4792e4691660\n# Removing intermediate container 4792e4691660\n#  ---\x3e 3199372aa3fc\n# Successfully built 3199372aa3fc\n'})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"docker image build"})," is the command for building the image. The daemon finds any file named ",(0,a.jsx)(n.code,{children:"Dockerfile"})," within the context."]}),"\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"."})," at the end sets the context for this build. The context means the directory accessible by the daemon during the build process."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"To run a container using this image, run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'docker container run --rm --detach --name custom-nginx-packaged --publish 8080:80 3199372aa3fc\n\n# ec09d4e1f70c903c3b954c8d7958421cdd1ae3d079b57f929e44131fbf8069a0\n\ndocker container ls\n\n# CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES\n# ec09d4e1f70c        3199372aa3fc        "nginx -g \'daemon of\u2026"   23 seconds ago      Up 22 seconds       0.0.0.0:8080->80/tcp   custom-nginx-packaged\n'})}),"\n",(0,a.jsx)(n.h2,{id:"tag-docker-image",children:"Tag docker Image"}),"\n",(0,a.jsx)(n.p,{children:"You can assign custom identifiers to your images instead of relying on the randomly generated ID."}),"\n",(0,a.jsxs)(n.p,{children:["In case of an image, it's called ",(0,a.jsx)(n.strong,{children:"tagging"})," instead of ",(0,a.jsx)(n.strong,{children:"naming"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"--tag <image repository>:<image tag>\n"})}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'docker image build --tag custom-nginx:packaged .\n\n# Sending build context to Docker daemon  1.055MB\n# Step 1/4 : FROM ubuntu:latest\n#  ---\x3e f63181f19b2f\n# Step 2/4 : EXPOSE 80\n#  ---\x3e Running in 53ab370b9efc\n# Removing intermediate container 53ab370b9efc\n#  ---\x3e 6d6460a74447\n# Step 3/4 : RUN apt-get update &&     apt-get install nginx -y &&     apt-get clean && rm -rf /var/lib/apt/lists/*\n#  ---\x3e Running in b4951b6b48bb\n### LONG INSTALLATION STUFF GOES HERE ###\n# Removing intermediate container b4951b6b48bb\n#  ---\x3e fdc6cdd8925a\n# Step 4/4 : CMD ["nginx", "-g", "daemon off;"]\n#  ---\x3e Running in 3bdbd2af4f0e\n# Removing intermediate container 3bdbd2af4f0e\n#  ---\x3e f8837621b99d\n# Successfully built f8837621b99d\n# Successfully tagged custom-nginx:packaged\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In cases where you forgot to tag an image during build time, or maybe you want to change the tag, you can use the ",(0,a.jsx)(n.code,{children:"image tag"})," command to do that:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker image tag <image id> <image repository>:<image tag>\n\n## or ##\n\ndocker image tag <image repository>:<image tag> <new image repository>:<new image tag>\n"})}),"\n",(0,a.jsx)(n.h2,{id:"list-and-remove-images",children:"List and Remove Images"}),"\n",(0,a.jsxs)(n.p,{children:["Use ",(0,a.jsx)(n.code,{children:"container ls"})," to list all the images in your local system:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker image ls\n\n# REPOSITORY     TAG        IMAGE ID       CREATED         SIZE\n# <none>         <none>     3199372aa3fc   7 seconds ago   132MB\n# custom-nginx   packaged   f8837621b99d   4 minutes ago   132MB\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Use ",(0,a.jsx)(n.code,{children:"image rm"})," to delete the image. The identifier can be the image ID or image repository. If you use the repository, you'll have to identify the tag as well"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker image rm <image identifier>\n"})}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker image rm custom-nginx:packaged\n\n# Untagged: custom-nginx:packaged\n# Deleted: sha256:f8837621b99d3388a9e78d9ce49fbb773017f770eea80470fb85e0052beae242\n# Deleted: sha256:fdc6cdd8925ac25b9e0ed1c8539f96ad89ba1b21793d061e2349b62dd517dadf\n# Deleted: sha256:c20e4aa46615fe512a4133089a5cd66f9b7da76366c96548790d5bf865bd49c4\n# Deleted: sha256:6d6460a744475a357a2b631a4098aa1862d04510f3625feb316358536fcd8641\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Use ",(0,a.jsx)(n.code,{children:"image prune"})," to clean up all un-tagged dangling images"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"docker image prune --force\n\n# Deleted Images:\n# deleted: sha256:ba9558bdf2beda81b9acc652ce4931a85f0fc7f69dbc91b4efc4561ef7378aff\n# deleted: sha256:ad9cc3ff27f0d192f8fa5fadebf813537e02e6ad472f6536847c4de183c02c81\n# deleted: sha256:f1e9b82068d43c1bb04ff3e4f0085b9f8903a12b27196df7f1145aa9296c85e7\n# deleted: sha256:ec16024aa036172544908ec4e5f842627d04ef99ee9b8d9aaa26b9c2a4b52baa\n\n# Total reclaimed space: 59.19MB\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"--force"})," or ",(0,a.jsx)(n.code,{children:"-f"})," option skips any confirmation questions."]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"--all"})," or ",(0,a.jsx)(n.code,{children:"-a"})," option to remove all cached images in your local registry."]}),"\n",(0,a.jsx)(n.h2,{id:"layers-of-docker-image",children:"Layers of Docker Image"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:"https://docs.docker.com/storage/storagedriver/images/container-layers.webp",alt:"Docker official - Layers of Image"})}),"\n",(0,a.jsxs)(n.p,{children:["To visualize the many layers of an image, you can use the ",(0,a.jsx)(n.code,{children:"image history"})," command."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'docker image history custom-nginx:packaged\n\n# IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n# 7f16387f7307        5 minutes ago       /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon\u2026   0B\n# 587c805fe8df        5 minutes ago       /bin/sh -c apt-get update &&     apt-get ins\u2026   60MB\n# 6fe4e51e35c1        6 minutes ago       /bin/sh -c #(nop)  EXPOSE 80                    0B\n# d70eaf7277ea        17 hours ago        /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B\n# <missing>           17 hours ago        /bin/sh -c mkdir -p /run/systemd && echo \'do\u2026   7B\n# <missing>           17 hours ago        /bin/sh -c [ -z "$(apt-get indextargets)" ]     0B\n# <missing>           17 hours ago        /bin/sh -c set -xe   && echo \'#!/bin/sh\' > /\u2026   811B\n# <missing>           17 hours ago        /bin/sh -c #(nop) ADD file:435d9776fdd3a1834\u2026   72.9MB\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"The image comprises of many read-only layers, each recording a new set of changes to the state triggered by certain instructions."}),"\n",(0,a.jsx)(n.p,{children:"When you start a container using an image, you get a new writable layer on top of the other layers."}),"\n",(0,a.jsx)(n.p,{children:"This layering phenomenon that happens every time you work with Docker has been made possible by a union file system."}),"\n",(0,a.jsx)(n.p,{children:"By utilizing this concept, Docker can avoid data duplication and can use previously created layers as a cache for later builds. This results in compact, efficient images that can be used everywhere."}),"\n",(0,a.jsx)(n.h2,{id:"build-nginx-from-source",children:"Build NGINX from Source"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="Dockerfile"',children:'FROM ubuntu:latest\n\nRUN apt-get update && \\\n    apt-get install build-essential\\\n                    libpcre3 \\\n                    libpcre3-dev \\\n                    zlib1g \\\n                    zlib1g-dev \\\n                    libssl1.1 \\\n                    libssl-dev \\\n                    -y && \\\n    apt-get clean && rm -rf /var/lib/apt/lists/*\n\nCOPY nginx-1.19.2.tar.gz .\n\nRUN tar -xvf nginx-1.19.2.tar.gz && rm nginx-1.19.2.tar.gz\n\nRUN cd nginx-1.19.2 && \\\n    ./configure \\\n        --sbin-path=/usr/bin/nginx \\\n        --conf-path=/etc/nginx/nginx.conf \\\n        --error-log-path=/var/log/nginx/error.log \\\n        --http-log-path=/var/log/nginx/access.log \\\n        --with-pcre \\\n        --pid-path=/var/run/nginx.pid \\\n        --with-http_ssl_module && \\\n    make && make install\n\nRUN rm -rf /nginx-1.19.2\n\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,a.jsx)(n.p,{children:"This can be done in 7 steps:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Get a good base image for building the application"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"FROM"})," instruction sets Ubuntu as the base image making an ideal environment for building any application."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Install necessary build dependencies on the base image."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"RUN"})," instruction installs standard packages necessary for building NGINX from source."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Copy the source file inside the image."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"COPY"})," instruction is responsible for copying the the ",(0,a.jsx)(n.code,{children:"nginx-1.19.2.tar.gz"})," file inside the image."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Extract the contents of the archive and get rid of it."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The ",(0,a.jsx)(n.code,{children:"RUN"})," instruction here extracts the contents from the archive using tar and gets rid of it afterwards."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Configure the build, compile and install the program using the make tool."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The archive file contains a directory called ",(0,a.jsx)(n.code,{children:"nginx-1.19.2"})," containing the source code. So in the next ",(0,a.jsx)(n.code,{children:"RUN"})," instruction, you'll have to cd inside that directory and perform the build process."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Get rid of the extracted source code."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Once the build and installation is complete, you continue to use ",(0,a.jsx)(n.code,{children:"RUN"})," instruction to remove the ",(0,a.jsx)(n.code,{children:"nginx-1.19.2"})," directory using ",(0,a.jsx)(n.code,{children:"rm"})," command."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Run nginx executable."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["On the final step you start NGINX in single process by using ",(0,a.jsx)(n.code,{children:"CMD"})," intruction like before."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Now we can build an image:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'docker image build --tag custom-nginx:built .\n\n# Step 1/7 : FROM ubuntu:latest\n#  ---\x3e d70eaf7277ea\n# Step 2/7 : RUN apt-get update &&     apt-get install build-essential                    libpcre3                     libpcre3-dev                     zlib1g                     zlib1g-dev                     libssl-dev                     -y &&     apt-get clean && rm -rf /var/lib/apt/lists/*\n#  ---\x3e Running in 2d0aa912ea47\n### LONG INSTALLATION STUFF GOES HERE ###\n# Removing intermediate container 2d0aa912ea47\n#  ---\x3e cbe1ced3da11\n# Step 3/7 : COPY nginx-1.19.2.tar.gz .\n#  ---\x3e 7202902edf3f\n# Step 4/7 : RUN tar -xvf nginx-1.19.2.tar.gz && rm nginx-1.19.2.tar.gz\n# ---\x3e Running in 4a4a95643020\n### LONG EXTRACTION STUFF GOES HERE ###\n# Removing intermediate container 4a4a95643020\n#  ---\x3e f9dec072d6d6\n# Step 5/7 : RUN cd nginx-1.19.2 &&     ./configure         --sbin-path=/usr/bin/nginx         --conf-path=/etc/nginx/nginx.conf         --error-log-path=/var/log/nginx/error.log         --http-log-path=/var/log/nginx/access.log         --with-pcre         --pid-path=/var/run/nginx.pid         --with-http_ssl_module &&     make && make install\n#  ---\x3e Running in b07ba12f921e\n### LONG CONFIGURATION AND BUILD STUFF GOES HERE ###\n# Removing intermediate container b07ba12f921e\n#  ---\x3e 5a877edafd8b\n# Step 6/7 : RUN rm -rf /nginx-1.19.2\n#  ---\x3e Running in 947e1d9ba828\n# Removing intermediate container 947e1d9ba828\n#  ---\x3e a7702dc7abb7\n# Step 7/7 : CMD ["nginx", "-g", "daemon off;"]\n#  ---\x3e Running in 3110c7fdbd57\n# Removing intermediate container 3110c7fdbd57\n#  ---\x3e eae55f7369d3\n# Successfully built eae55f7369d3\n# Successfully tagged custom-nginx:built\n'})}),"\n",(0,a.jsx)(n.p,{children:"There are some places where we can make improvements:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Instead of hard coding the filename, you can create an argument using the ",(0,a.jsx)(n.code,{children:"ARG"})," instruction."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Instead of downloading the archive manually, you can let the daemon download the file from the internet during the build process using ",(0,a.jsx)(n.code,{children:"ADD"})," instruction."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.admonition,{type:"danger",children:[(0,a.jsxs)(n.p,{children:["It isn't recommended to use build arguments for passing secrets such as user credentials, API tokens, etc. Build arguments are visible in the ",(0,a.jsx)(n.code,{children:"docker history"})," command and in ",(0,a.jsx)(n.code,{children:"max"})," mode provenance attestations."]}),(0,a.jsxs)(n.p,{children:["Ref: ",(0,a.jsx)(n.a,{href:"https://docs.docker.com/reference/dockerfile/#arg",children:"Docker Official - DockerFile #arg"})]})]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"Dockerfile"})," will be updated as follow:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="Dockerfile"',children:'FROM ubuntu:latest\n\nRUN apt-get update && \\\n    apt-get install build-essential\\\n                    libpcre3 \\\n                    libpcre3-dev \\\n                    zlib1g \\\n                    zlib1g-dev \\\n                    libssl1.1 \\\n                    libssl-dev \\\n                    -y && \\\n    apt-get clean && rm -rf /var/lib/apt/lists/*\n\nARG FILENAME="nginx-1.19.2"\nARG EXTENSION="tar.gz"\n\nADD https://nginx.org/download/${FILENAME}.${EXTENSION} .\n\nRUN tar -xvf ${FILENAME}.${EXTENSION} && rm ${FILENAME}.${EXTENSION}\n\nRUN cd ${FILENAME} && \\\n    ./configure \\\n        --sbin-path=/usr/bin/nginx \\\n        --conf-path=/etc/nginx/nginx.conf \\\n        --error-log-path=/var/log/nginx/error.log \\\n        --http-log-path=/var/log/nginx/access.log \\\n        --with-pcre \\\n        --pid-path=/var/run/nginx.pid \\\n        --with-http_ssl_module && \\\n    make && make install\n\nRUN rm -rf /${FILENAME}}\n\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,a.jsx)(n.h2,{id:"optimize-docker-image",children:"Optimize Docker Image"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"RUN"})," instruction installs a lot of stuff. Although these packages are necessary for building NGINX from source, they are not necessary for running it, only two are necessary for running NGINX. These are ",(0,a.jsx)(n.code,{children:"libpcre3"})," and ",(0,a.jsx)(n.code,{children:"zlib1g"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"So a better idea would be to uninstall the other packages once the build process is done."}),"\n",(0,a.jsxs)(n.p,{children:["The updated ",(0,a.jsx)(n.code,{children:"Dockerfile"})," will be as follow:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="Dockerfile"',children:'FROM ubuntu:latest\n\nEXPOSE 80\n\nARG FILENAME="nginx-1.19.2"\nARG EXTENSION="tar.gz"\n\nADD https://nginx.org/download/${FILENAME}.${EXTENSION} .\n\nRUN apt-get update && \\\n    apt-get install build-essential \\\n                    libpcre3 \\\n                    libpcre3-dev \\\n                    zlib1g \\\n                    zlib1g-dev \\\n                    libssl1.1 \\\n                    libssl-dev \\\n                    -y && \\\n    tar -xvf ${FILENAME}.${EXTENSION} && rm ${FILENAME}.${EXTENSION} && \\\n    cd ${FILENAME} && \\\n    ./configure \\\n        --sbin-path=/usr/bin/nginx \\\n        --conf-path=/etc/nginx/nginx.conf \\\n        --error-log-path=/var/log/nginx/error.log \\\n        --http-log-path=/var/log/nginx/access.log \\\n        --with-pcre \\\n        --pid-path=/var/run/nginx.pid \\\n        --with-http_ssl_module && \\\n    make && make install && \\\n    cd / && rm -rfv /${FILENAME} && \\\n    # highlight-start\n    apt-get remove build-essential \\\n                    libpcre3-dev \\\n                    zlib1g-dev \\\n                    libssl-dev \\\n                    -y && \\\n    apt-get autoremove -y && \\\n    apt-get clean && rm -rf /var/lib/apt/lists/*\n    # highlight-end\n\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,a.jsx)(n.p,{children:"By run those commands, the unnecessary packages are being uninstalled and cache cleared."}),"\n",(0,a.jsxs)(n.admonition,{type:"info",children:[(0,a.jsxs)(n.p,{children:["If you install packages and then remove them in separate ",(0,a.jsx)(n.code,{children:"RUN"})," instructions, they'll live in ",(0,a.jsx)(n.em,{children:"separate layers of the image"}),"."]}),(0,a.jsx)(n.p,{children:"Although the final image will not have the removed packages, their size will still be added to the final image since they exist in one of the layers consisting the image."}),(0,a.jsxs)(n.p,{children:["So make sure you ",(0,a.jsx)(n.strong,{children:"make these kind of changes on a single layer"}),"."]})]}),"\n",(0,a.jsx)(n.h2,{id:"embracing-alpine-linux",children:"Embracing Alpine Linux"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://alpinelinux.org/",children:"Alpine"})," is lightweight, secure and is a much better fit for creating containers than the other distributions."]}),"\n",(0,a.jsxs)(n.p,{children:["You can update ",(0,a.jsx)(n.code,{children:"Dockerfile"})," using Alpine as follow:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'FROM alpine:latest\n\nEXPOSE 80\n\nARG FILENAME="nginx-1.19.2"\nARG EXTENSION="tar.gz"\n\nADD https://nginx.org/download/${FILENAME}.${EXTENSION} .\n\nRUN apk add --no-cache pcre zlib && \\\n    apk add --no-cache \\\n            --virtual .build-deps \\\n            build-base \\\n            pcre-dev \\\n            zlib-dev \\\n            openssl-dev && \\\n    tar -xvf ${FILENAME}.${EXTENSION} && rm ${FILENAME}.${EXTENSION} && \\\n    cd ${FILENAME} && \\\n    ./configure \\\n        --sbin-path=/usr/bin/nginx \\\n        --conf-path=/etc/nginx/nginx.conf \\\n        --error-log-path=/var/log/nginx/error.log \\\n        --http-log-path=/var/log/nginx/access.log \\\n        --with-pcre \\\n        --pid-path=/var/run/nginx.pid \\\n        --with-http_ssl_module && \\\n    make && make install && \\\n    cd / && rm -rfv /${FILENAME} && \\\n    apk del .build-deps\n\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"apk add"})," is as same as ",(0,a.jsx)(n.code,{children:"apt-get install"})," in ubuntu, using for installing packages."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"apk del"})," is as same as ",(0,a.jsx)(n.code,{children:"apt-get remove"})," in ubuntu, using for uninstalling packages."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"--no-cache"})," option means that the downloaded package won't be cached."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"--virtual"})," option for the apk add command is used for bundling a bunch of packages into a single virtual package for easier management."]}),"\n"]}),"\n"]})]})}function g(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},1151:(e,n,i)=>{i.d(n,{Z:()=>c,a:()=>r});var a=i(7294);const s={},t=a.createContext(s);function r(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);